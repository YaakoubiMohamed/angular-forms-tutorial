<div class="container">
  <h2>Formulaires R√©actifs - Inscription</h2>
  
  <p class="description">
    Cet exemple d√©montre les Formulaires R√©actifs (approche model-driven).
    La structure du formulaire est d√©finie en TypeScript avec FormBuilder.
    Le formulaire inclut des groupes imbriqu√©s et un FormArray pour les emails dynamiques.
  </p>

  <!-- Message d'erreur global -->
  @if (submitError) {
    <div class="alert alert-error">
      {{ submitError }}
    </div>
  }

  <!-- Formulaire Principal -->
  <form [formGroup]="registrationForm" (ngSubmit)="onSubmit()" class="form">
    
    <!-- Section: Informations Personnelles -->
    <fieldset [formGroup]="personalInfoGroup" class="form-section">
      <legend>üë§ Informations Personnelles</legend>

      <!-- Pr√©nom -->
      <div class="form-group">
        <label for="firstName">Pr√©nom:</label>
        <input
          id="firstName"
          type="text"
          formControlName="firstName"
          placeholder="Entrez votre pr√©nom"
          class="form-control"
          [class.is-invalid]="registrationForm.get('personalInfo.firstName')?.invalid && registrationForm.get('personalInfo.firstName')?.touched"
        />
        @if (registrationForm.get('personalInfo.firstName')?.touched && registrationForm.get('personalInfo.firstName')?.invalid) {
          <div class="error-message">
            {{ getErrorMessage('personalInfo.firstName') }}
          </div>
        }
      </div>

      <!-- Nom -->
      <div class="form-group">
        <label for="lastName">Nom:</label>
        <input
          id="lastName"
          type="text"
          formControlName="lastName"
          placeholder="Entrez votre nom"
          class="form-control"
          [class.is-invalid]="registrationForm.get('personalInfo.lastName')?.invalid && registrationForm.get('personalInfo.lastName')?.touched"
        />
        @if (registrationForm.get('personalInfo.lastName')?.touched && registrationForm.get('personalInfo.lastName')?.invalid) {
          <div class="error-message">
            {{ getErrorMessage('personalInfo.lastName') }}
          </div>
        }
      </div>

      <!-- Date de Naissance -->
      <div class="form-group">
        <label for="birthDate">Date de Naissance:</label>
        <input
          id="birthDate"
          type="date"
          formControlName="birthDate"
          class="form-control"
          [class.is-invalid]="registrationForm.get('personalInfo.birthDate')?.invalid && registrationForm.get('personalInfo.birthDate')?.touched"
        />
        @if (registrationForm.get('personalInfo.birthDate')?.touched && registrationForm.get('personalInfo.birthDate')?.invalid) {
          <div class="error-message">
            {{ getErrorMessage('personalInfo.birthDate') }}
          </div>
        }
      </div>
    </fieldset>

    <!-- Section: Informations de Contact -->
    <fieldset [formGroup]="contactInfoGroup" class="form-section">
      <legend>üìß Informations de Contact</legend>

      <!-- Email -->
      <div class="form-group">
        <label for="email">Email:</label>
        <input
          id="email"
          type="email"
          formControlName="email"
          placeholder="Entrez votre email"
          class="form-control"
          [class.is-invalid]="registrationForm.get('contactInfo.email')?.invalid && registrationForm.get('contactInfo.email')?.touched"
        />
        @if (registrationForm.get('contactInfo.email')?.touched && registrationForm.get('contactInfo.email')?.invalid) {
          <div class="error-message">
            {{ getErrorMessage('contactInfo.email') }}
          </div>
        }
      </div>

      <!-- T√©l√©phone -->
      <div class="form-group">
        <label for="phone">T√©l√©phone:</label>
        <input
          id="phone"
          type="tel"
          formControlName="phone"
          placeholder="+33 6 12 34 56 78"
          class="form-control"
          [class.is-invalid]="registrationForm.get('contactInfo.phone')?.invalid && registrationForm.get('contactInfo.phone')?.touched"
        />
        @if (registrationForm.get('contactInfo.phone')?.touched && registrationForm.get('contactInfo.phone')?.invalid) {
          <div class="error-message">
            {{ getErrorMessage('contactInfo.phone') }}
          </div>
        }
      </div>

      <!-- Site Web -->
      <div class="form-group">
        <label for="website">Site Web (optionnel):</label>
        <input
          id="website"
          type="url"
          formControlName="website"
          placeholder="https://example.com"
          class="form-control"
          [class.is-invalid]="registrationForm.get('contactInfo.website')?.invalid && registrationForm.get('contactInfo.website')?.touched"
        />
        @if (registrationForm.get('contactInfo.website')?.touched && registrationForm.get('contactInfo.website')?.invalid) {
          <div class="error-message">
            {{ getErrorMessage('contactInfo.website') }}
          </div>
        }
      </div>
    </fieldset>

    <!-- Section: Mots de Passe -->
    <fieldset [formGroup]="passwordsGroup" class="form-section">
      <legend>üîê Mots de Passe</legend>

      <!-- Mot de Passe -->
      <div class="form-group">
        <label for="password">Mot de Passe:</label>
        <input
          id="password"
          [type]="showPassword ? 'text' : 'password'"
          formControlName="password"
          placeholder="Minimum 8 caract√®res"
          class="form-control"
          [class.is-invalid]="registrationForm.get('passwords.password')?.invalid && registrationForm.get('passwords.password')?.touched"
        />
        @if (registrationForm.get('passwords.password')?.touched && registrationForm.get('passwords.password')?.invalid) {
          <div class="error-message">
            {{ getErrorMessage('passwords.password') }}
          </div>
        }
      </div>

      <!-- Confirmer le Mot de Passe -->
      <div class="form-group">
        <label for="confirmPassword">Confirmer le Mot de Passe:</label>
        <input
          id="confirmPassword"
          [type]="showPassword ? 'text' : 'password'"
          formControlName="confirmPassword"
          placeholder="Confirmez votre mot de passe"
          class="form-control"
          [class.is-invalid]="registrationForm.get('passwords.confirmPassword')?.invalid && registrationForm.get('passwords.confirmPassword')?.touched"
        />
        @if (registrationForm.get('passwords.confirmPassword')?.touched && registrationForm.get('passwords.confirmPassword')?.invalid) {
          <div class="error-message">
            {{ getErrorMessage('passwords.confirmPassword') }}
          </div>
        }
      </div>

      <!-- Erreur de Correspondance de Mots de Passe (au niveau du groupe) -->
      @if (registrationForm.get('passwords')?.hasError('passwordMismatch') && registrationForm.get('passwords')?.touched) {
        <div class="error-message group-error">
          ‚ö†Ô∏è {{ getErrorMessage('passwords') }}
        </div>
      }
    </fieldset>

    <!-- Section: Emails Suppl√©mentaires (FormArray) -->
    <fieldset class="form-section">
      <legend>üì® Emails Suppl√©mentaires</legend>
      @for (emailControl of additionalEmailsArray.controls; let i = $index; track i) {
          <div class="form-group email-array-item">
            <label [for]="'additionalEmail' + i">Email Suppl√©mentaire {{ i + 1 }}:</label>
            <div class="email-input-wrapper">
              <input
                [id]="'additionalEmail' + i"
                type="email"
                [formControl]="getEmailControl(i)"
                placeholder="Email optionnel"
                class="form-control"
                [class.is-invalid]="getEmailControl(i).invalid && getEmailControl(i).touched"
              />
              <button
                type="button"
                (click)="removeEmail(i)"
                class="btn btn-danger btn-small"
              >
                Supprimer
              </button>
            </div>
            @if (getEmailControl(i).invalid && getEmailControl(i).touched) {
              <div class="error-message">
                {{ getErrorMessage('additionalEmails') }}
              </div>
            }
          </div>
        }
      <button
        type="button"
        (click)="addEmail()"
        class="btn btn-secondary"
      >
        + Ajouter un Email Suppl√©mentaire
      </button>
    </fieldset>

    <!-- Acceptation des Conditions -->
    <div class="form-group checkbox">
      <input
        id="acceptTerms"
        type="checkbox"
        formControlName="acceptTerms"
      />
      <label for="acceptTerms">J'accepte les conditions d'utilisation</label>
      @if (registrationForm.get('acceptTerms')?.invalid && registrationForm.get('acceptTerms')?.touched) {
        <div class="error-message">
          {{ getErrorMessage('acceptTerms') }}
        </div>
      }
    </div>

    <!-- Boutons d'Action -->
    <div class="button-group">
      <button
        type="submit"
        [disabled]="registrationForm.invalid && submitted"
        class="btn btn-primary"
      >
        Soumettre l'Inscription
      </button>

      <button
        type="button"
        (click)="resetForm()"
        class="btn btn-secondary"
      >
        R√©initialiser
      </button>

      <button
        type="button"
        (click)="prefillForm()"
        class="btn btn-info"
      >
        Remplir Demo
      </button>

      <button
        type="button"
        (click)="togglePasswordField()"
        class="btn btn-warning"
      >
        {{ showPassword ? 'üôà Masquer' : 'üëÅÔ∏è Afficher' }} le Mot de Passe
      </button>
    </div>
  </form>

  <!-- Affichage de l'√âtat du Formulaire -->
  <div class="form-state">
    <h3>üìä √âtat du Formulaire (Suivi R√©actif)</h3>
    <div class="state-grid">
      <div class="state-item" [class.valid]="registrationForm.valid">
        <strong>Formulaire Valide:</strong> {{ registrationForm.valid }}
      </div>
      <div class="state-item" [class.invalid]="registrationForm.invalid">
        <strong>Formulaire Invalide:</strong> {{ registrationForm.invalid }}
      </div>
      <div class="state-item" [class.dirty]="registrationForm.dirty">
        <strong>Formulaire Modifi√©:</strong> {{ registrationForm.dirty }}
      </div>
      <div class="state-item" [class.pristine]="registrationForm.pristine">
        <strong>Formulaire Vierge:</strong> {{ registrationForm.pristine }}
      </div>
      <div class="state-item" [class.touched]="registrationForm.touched">
        <strong>Formulaire Touch√©:</strong> {{ registrationForm.touched }}
      </div>
      <div class="state-item" [class.untouched]="registrationForm.untouched">
        <strong>Formulaire Non Touch√©:</strong> {{ registrationForm.untouched }}
      </div>
      <div class="state-item">
        <strong>√âtat du Formulaire:</strong> {{ registrationForm.status }}
      </div>
      <div class="state-item">
        <strong>Nombre d'Emails:</strong> {{ additionalEmailsArray.length }}
      </div>
    </div>
  </div>

  <!-- Affichage de la Valeur du Formulaire -->
  <div class="form-value">
    <h3>üìù Valeur Actuelle du Formulaire (Mise √† jour en Temps R√©el)</h3>
    <pre>{{ registrationForm.value | json }}</pre>
  </div>

  <!-- Affichage des Donn√©es Soumises -->
  @if (submittedData) {
    <div class="submitted-data">
      <h3>‚úÖ Formulaire Soumis avec Succ√®s!</h3>
      <p>Les donn√©es suivantes ont √©t√© soumises:</p>
      <pre>{{ submittedData | json }}</pre>
    </div>
  }

  <!-- Concepts Cl√©s -->
  <div class="concepts">
    <h3>üéì Concepts Cl√©s D√©montr√©s:</h3>
    <ul>
      <li><strong>FormBuilder:</strong> Service pour cr√©er facilement des FormGroups</li>
      <li><strong>FormGroup:</strong> Groupe plusieurs FormControls ensemble</li>
      <li><strong>FormControl:</strong> Contr√¥le de champ individuel (cr√©√© implicitement)</li>
      <li><strong>FormArray:</strong> Tableau de contr√¥les pour les champs dynamiques</li>
      <li><strong>Validateurs:</strong> required, email, minLength, pattern appliqu√©s</li>
      <li><strong>√âtat du Formulaire:</strong> valid, dirty, touched, pristine suivi automatiquement</li>
      <li><strong>Groupes Imbriqu√©s:</strong> Grouper les contr√¥les connexes (personalInfo, contactInfo, passwords)</li>
      <li><strong>Validateurs Personnalis√©s:</strong> Validateur passwordMismatch au niveau du groupe</li>
      <li><strong>Contr√¥le Programmatique:</strong> patchValue(), setValue(), reset(), enable(), disable()</li>
      <li><strong>Gestion des Erreurs:</strong> Afficher les messages en fonction de la validation</li>
      <li><strong>Soumission:</strong> Acc√©der aux donn√©es du formulaire via registrationForm.value</li>
      <li><strong>Champs Dynamiques:</strong> Ajouter/supprimer des emails avec FormArray</li>
    </ul>
  </div>

  <!-- Avantages des Formulaires R√©actifs -->
  <div class="advantages">
    <h3>üí° Avantages des Formulaires R√©actifs:</h3>
    <div class="advantage-grid">
      <div class="advantage-card">
        <h4>üéØ Contr√¥le Total</h4>
        <p>D√©finition compl√®te du formulaire en TypeScript avec acc√®s programmatique</p>
      </div>
      <div class="advantage-card">
        <h4>üß™ Testabilit√©</h4>
        <p>Facile √† tester car la logique est en TypeScript, pas en template</p>
      </div>
      <div class="advantage-card">
        <h4>‚ö° R√©activit√©</h4>
        <p>Utilise les Observables de RxJS pour une programmation r√©active</p>
      </div>
      <div class="advantage-card">
        <h4>üîÑ Champs Dynamiques</h4>
        <p>FormArray permet d'ajouter/supprimer des champs facilement</p>
      </div>
      <div class="advantage-card">
        <h4>üì¶ R√©utilisabilit√©</h4>
        <p>Validateurs et logique partag√©s entre composants</p>
      </div>
      <div class="advantage-card">
        <h4>üé® Flexibilit√©</h4>
        <p>Impl√©menter des validations cross-field et des logiques complexes</p>
      </div>
    </div>
  </div>
</div>
